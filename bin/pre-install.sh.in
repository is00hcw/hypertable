#!/bin/bash -x
#
# Copyright (C) 2007-2012 Hypertable, Inc.
#
# This file is part of Hypertable.
#
# Hypertable is free software; you can redistribute it and/or
# modify it under the terms of the GNU General Public License
# as published by the Free Software Foundation; either version 3
# of the License, or any later version.
#
# Hypertable is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with Hypertable. If not, see <http://www.gnu.org/licenses/>
#

rm -rf /tmp/hypertable-install

if [ -h /opt/hypertable/current ]; then

  mkdir /tmp/hypertable-install

  echo "#\!/bin/bash" | sed 's/\\//g' > /tmp/hypertable-install/post.sh
  chmod 755 /tmp/hypertable-install/post.sh

  OLDVERSION=`readlink /opt/hypertable/current`

  if ! echo $OLDVERSION | grep "^/" > /dev/null ; then
    OLDVERSION="/opt/hypertable/$OLDVERSION"
  fi

  # conf
  if [ -h $OLDVERSION/conf ]; then
    echo "ln -s `readlink $OLDVERSION/conf` /opt/hypertable/@VERSION@/conf" >> /tmp/hypertable-install/post.sh
    rm -f $OLDVERSION/conf
  elif [ -d $OLDVERSION/conf ]; then
    if [ -e $OLDVERSION/conf/hypertable.cfg ]; then
      cp $OLDVERSION/conf/*.cfg /tmp/hypertable-install/
    fi
    if [ -e $OLDVERSION/conf/notification-hook.sh ]; then
      cp $OLDVERSION/conf/notification-hook.sh /tmp/hypertable-install/
    fi
  fi
  
  # hyperspace
  if [ -h $OLDVERSION/hyperspace ]; then
    echo "ln -s `readlink $OLDVERSION/hyperspace` /opt/hypertable/@VERSION@/hyperspace" >> /tmp/hypertable-install/post.sh
    rm -f $OLDVERSION/hyperspace
  fi
  
  # fs
  if [ -h $OLDVERSION/fs ]; then
    echo "ln -s `readlink $OLDVERSION/fs` /opt/hypertable/@VERSION@/fs" >> /tmp/hypertable-install/post.sh
    rm -f $OLDVERSION/fs
  fi
  
  # run
  if [ -h $OLDVERSION/run ]; then
    echo "ln -s `readlink $OLDVERSION/run` /opt/hypertable/@VERSION@/run" >> /tmp/hypertable-install/post.sh
    rm -f $OLDVERSION/run
  fi
  
  # log
  if [ -h $OLDVERSION/log ]; then
    echo "ln -s `readlink $OLDVERSION/log` /opt/hypertable/@VERSION@/log" >> /tmp/hypertable-install/post.sh
    rm -f $OLDVERSION/log
  fi
fi
  